# Production environment overrides
global:
  environment: prod
  imageTag: v1.0.1
  # 실제 RDS 엔드포인트
  database:
    host: goorm-popcorn-prod-postgres.cds4g0gykt3t.ap-northeast-2.rds.amazonaws.com
    port: 5432
    name: popcorn_prod
  # 실제 ElastiCache 엔드포인트
  redis:
    host: master.goorm-popcorn-cache-prod.mkltth.apn2.cache.amazonaws.com
    port: 6379
  # Kafka 설정 (infrastructure/kafka에서 배포)
  kafka:
    bootstrapServers: kafka-prod.kafka.svc.cluster.local:9092
  frontend:
    appUrl: "https://goormpopcorn.shop"
    apiBaseUrl: "https://api.goormpopcorn.shop"
    storeApiBaseUrl: "https://api.goormpopcorn.shop"
    orderQueryApiBaseUrl: "https://api.goormpopcorn.shop"
    paymentApiBaseUrl: "https://api.goormpopcorn.shop"
# 운영 환경 고가용성 설정
frontend:
  enabled: true
  replicaCount: 1
  image:
    tag: v1.0.1
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 60
  env:
    NEXT_PUBLIC_APP_URL: "{{ .Values.global.frontend.appUrl }}"
    NEXT_PUBLIC_API_BASE_URL: "{{ .Values.global.frontend.apiBaseUrl }}"
    NEXT_PUBLIC_STORE_API_BASE_URL: "{{ .Values.global.frontend.storeApiBaseUrl }}"
    NEXT_PUBLIC_ORDERQUERY_API_BASE_URL: "{{ .Values.global.frontend.orderQueryApiBaseUrl }}"
    NEXT_PUBLIC_PAYMENT_API_BASE_URL: "{{ .Values.global.frontend.paymentApiBaseUrl }}"
    NEXT_PUBLIC_TOSS_SUCCESS_URL: "https://goormpopcorn.shop/payments/success"
    NEXT_PUBLIC_TOSS_FAIL_URL: "https://goormpopcorn.shop/payments/fail"
    NEXT_PUBLIC_TOSS_CLIENT_KEY:
      valueFrom:
        secretKeyRef:
          name: payment-api-keys
          key: TOSS_PAYMENTS_CLIENT_KEY
  ingress:
    enabled: true
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/healthcheck-path: /
      alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
      alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "10"
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:375896310755:certificate/085e3315-785c-480d-93c2-57f656b60f7b
      alb.ingress.kubernetes.io/ssl-redirect: "443"
    hosts:
      - host: goormpopcorn.shop
        paths:
          - path: /
            pathType: Prefix
gateway:
  replicaCount: 1
  image:
    tag: dev-3e979749
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  autoscaling:
    enabled: false
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 330
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    LOGGING_LEVEL_ROOT: "WARN"
    JAVA_OPTS: "-Xms512m -Xmx1024m"
    SPRING_DATA_REDIS_HOST:
      valueFrom:
        secretKeyRef:
          name: redis-credentials
          key: host
    SPRING_DATA_REDIS_PORT:
      valueFrom:
        secretKeyRef:
          name: redis-credentials
          key: port
    SPRING_DATA_REDIS_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: redis-credentials
          key: password
    JWT_SECRET:
      valueFrom:
        secretKeyRef:
          name: jwt-secret
          key: JWT_SECRET
    PASSPORT_SECRET:
      valueFrom:
        secretKeyRef:
          name: passport-secret
          key: PASSPORT_SECRET
    # gateway application.yaml placeholder 변수들 (k8s prod 기준)
    GATEWAY_SERVICE_URL: "https://api.goormpopcorn.shop"
    CHECKIN_SERVICE_URL: "http://popcorn-prod-checkins:8080"
    GATEWAY_URL: "http://popcorn-prod-gateway:8080"
    # 기존 문서에서 CHECKINS_SERVICE_URL로 쓰인 호환값 (동일 값 유지)
    CHECKINS_SERVICE_URL: "http://popcorn-prod-checkins:8080"
    COUPON_SERVICE_URL: "http://popcorn-prod-coupon:8080"
    BACKEND_SERVICE_URL: "http://popcorn-prod-backend:8080"
    USER_SERVICE_URL: "http://popcorn-prod-users:8080"
    STORE_SERVICE_URL: "http://popcorn-prod-stores:8080"
    ORDER_SERVICE_URL: "http://popcorn-prod-order:8080"
    PAYMENT_SERVICE_URL: "http://popcorn-prod-payment:8080"
    ORDERQUERY_SERVICE_URL: "http://popcorn-prod-order-query:8080"
  ingress:
    enabled: true
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/healthcheck-path: /actuator/health/liveness
      alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
      alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "10"
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:375896310755:certificate/085e3315-785c-480d-93c2-57f656b60f7b
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/actions.redirect-root-to-swagger: >-
        {"Type":"redirect","RedirectConfig":{"Protocol":"HTTPS","Port":"443","Host":"#{host}","Path":"/swagger-ui/webjars/swagger-ui/index.html","Query":"#{query}","StatusCode":"HTTP_302"}}
    hosts:
      - host: api.goormpopcorn.shop
        paths:
          - path: /api
            pathType: Prefix
          - path: /swagger-ui.html
            pathType: Exact
          - path: /swagger-ui
            pathType: Prefix
          - path: /v3/api-docs
            pathType: Prefix
          - path: /actuator
            pathType: Prefix
          # 루트 경로는 Swagger UI 웹자원 경로로 ALB 리다이렉트
          - path: /
            pathType: Prefix
            backend:
              service:
                name: redirect-root-to-swagger
                port:
                  name: use-annotation
users:
  replicaCount: 1
  image:
    tag: dev-3e979749
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  autoscaling:
    enabled: false
    minReplicas: 3
    maxReplicas: 8
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
  healthCheck:
    initialDelaySeconds: 150
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    JAVA_OPTS: "-Xms512m -Xmx1024m"
    APP_GATEWAY_URL: "https://api.goormpopcorn.shop"
    SPRING_DATASOURCE_URL: "jdbc:postgresql://goorm-popcorn-prod-postgres.cds4g0gykt3t.ap-northeast-2.rds.amazonaws.com:5432/popcorn_prod?currentSchema=user_auth"
    SPRING_DATASOURCE_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: USER_AUTH_DB_USERNAME
    SPRING_DATASOURCE_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: USER_AUTH_DB_PASSWORD
stores:
  replicaCount: 1
  image:
    tag: dev-3e979749
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 6
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 150
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    JAVA_OPTS: "-Xms512m -Xmx1024m"
    SPRING_DATASOURCE_TYPE: "org.springframework.jdbc.datasource.SimpleDriverDataSource"
    JWT_SECRET:
      valueFrom:
        secretKeyRef:
          name: jwt-secret
          key: JWT_SECRET
    SPRING_DATASOURCE_URL: "jdbc:postgresql://goorm-popcorn-prod-postgres.cds4g0gykt3t.ap-northeast-2.rds.amazonaws.com:5432/popcorn_prod?currentSchema=store"
    SPRING_DATASOURCE_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: STORE_DB_USERNAME
    SPRING_DATASOURCE_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: STORE_DB_PASSWORD
    SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA: "store"
    SPRING_FLYWAY_ENABLED: "false"
    PASSPORT_SECRET:
      valueFrom:
        secretKeyRef:
          name: passport-secret
          key: PASSPORT_SECRET
order:
  replicaCount: 1
  image:
    tag: dev-3e979749
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  autoscaling:
    enabled: false
    minReplicas: 3
    maxReplicas: 10
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 150
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    JAVA_OPTS: "-Xms512m -Xmx1024m"
    GATEWAY_URL: "http://popcorn-prod-gateway:8080"
    CHECKINS_SERVICE_URL: "http://popcorn-prod-checkins:8080"
    FRONTEND_BASE_URL: "https://goormpopcorn.shop"
    # 운영 API 기준 기본 URL (order-query / 사용자 토큰 redirect 등과 충돌 방지)
    ORDER_SERVICE_BASE_URL: "http://popcorn-prod-gateway:8080"
    USER_SERVICE_BASE_URL: "http://popcorn-prod-gateway:8080"
    STORE_SERVICE_BASE_URL: "http://popcorn-prod-gateway:8080"
    ORDERQUERY_SERVICE_BASE_URL: "http://popcorn-prod-gateway:8080"
    SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "3"
    SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "1"
    SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: "5000"
    SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT: "300000"
    SPRING_DATASOURCE_HIKARI_MAX_LIFETIME: "900000"
    PASSPORT_SECRET:
      valueFrom:
        secretKeyRef:
          name: passport-secret
          key: PASSPORT_SECRET
  serviceUrls:
    gateway: "http://{{ .Release.Name }}-gateway:8080"
    users: "http://{{ .Release.Name }}-users:8080"
    stores: "http://{{ .Release.Name }}-stores:8080"
    payment: "http://{{ .Release.Name }}-payment:8080"
payment:
  enabled: true
  replicaCount: 1
  image:
    tag: dev-3e979749
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 5
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 360
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    JAVA_OPTS: "-Xms512m -Xmx1024m"
    ORDER_SERVICE_URL: "http://popcorn-prod-order:8080"
    GATEWAY_URL: "http://popcorn-prod-gateway:8080"
    PAYMENT_TOKEN_SECRET:
      valueFrom:
        secretKeyRef:
          name: jwt-secret
          key: JWT_SECRET
    TOSS_SECRET_KEY:
      valueFrom:
        secretKeyRef:
          name: payment-api-keys
          key: TOSS_PAYMENTS_SECRET_KEY
    TOSS_CLIENT_KEY:
      valueFrom:
        secretKeyRef:
          name: payment-api-keys
          key: TOSS_PAYMENTS_CLIENT_KEY
    SPRING_DATASOURCE_URL: "jdbc:postgresql://goorm-popcorn-prod-postgres.cds4g0gykt3t.ap-northeast-2.rds.amazonaws.com:5432/popcorn_prod?currentSchema=payment"
    SPRING_DATASOURCE_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: PAYMENT_DB_USERNAME
    SPRING_DATASOURCE_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: PAYMENT_DB_PASSWORD
    SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
    SPRING_FLYWAY_DEFAULT_SCHEMA: "payment"
    SPRING_FLYWAY_SCHEMAS: "payment"
    SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA: "payment"
    SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "2"
    SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "0"
    SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: "5000"
    SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT: "300000"
    SPRING_DATASOURCE_HIKARI_MAX_LIFETIME: "900000"
    PASSPORT_SECRET:
      valueFrom:
        secretKeyRef:
          name: passport-secret
          key: PASSPORT_SECRET
order-query:
  replicaCount: 1
  image:
    tag: v1.0.1
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 6
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 150
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    JAVA_OPTS: "-Xms512m -Xmx1024m"
    JWT_SECRET:
      valueFrom:
        secretKeyRef:
          name: jwt-secret
          key: JWT_SECRET
    SPRING_DATASOURCE_URL: "jdbc:postgresql://goorm-popcorn-prod-postgres.cds4g0gykt3t.ap-northeast-2.rds.amazonaws.com:5432/popcorn_prod?currentSchema=order_query"
    ORDER_QUERY_DB_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_DB_USERNAME
    ORDER_QUERY_DB_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_DB_PASSWORD
    ORDER_QUERY_FLYWAY_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_FLYWAY_USERNAME
    ORDER_QUERY_FLYWAY_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_FLYWAY_PASSWORD
    SPRING_DATASOURCE_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_DB_USERNAME
    SPRING_DATASOURCE_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_DB_PASSWORD
    STORE_DB_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_DB_USERNAME
    STORE_DB_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_DB_PASSWORD
    STORE_FLYWAY_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_FLYWAY_USERNAME
    STORE_FLYWAY_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: ORDER_QUERY_FLYWAY_PASSWORD
    SPRING_FLYWAY_DEFAULT_SCHEMA: "order_query"
    SPRING_FLYWAY_SCHEMAS: "order_query"
    SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA: "order_query"
    SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "2"
    SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "0"
    SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: "5000"
    SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT: "300000"
    SPRING_DATASOURCE_HIKARI_MAX_LIFETIME: "900000"
    PASSPORT_SECRET:
      valueFrom:
        secretKeyRef:
          name: passport-secret
          key: PASSPORT_SECRET
    SPRING_FLYWAY_MIXED: "true"
checkins:
  enabled: true
  replicaCount: 1
  image:
    tag: v1.0.1
  tolerations:
    - key: karpenter.sh/spot
      operator: Exists
      effect: NoSchedule
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      cpu: 300m
      memory: 512Mi
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 4
  rollout:
    enabled: true
    keepDeployment: false
    replicas: 1
    strategy: blueGreen
    blueGreen:
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 30
      previewReplicaCount: 1
    canary:
      maxSurge: "25%"
      maxUnavailable: 0
  healthCheck:
    initialDelaySeconds: 150
  env:
    SPRING_PROFILES_ACTIVE: "prod"
    JAVA_OPTS: "-Xms256m -Xmx512m"
    KAFKA_BOOTSTRAP_SERVERS: "kafka-prod.kafka.svc.cluster.local:9092"
    CHECKINS_KAFKA_CONSUMER_GROUP_ID: "checkins-service-group"
    PASSPORT_SECRET:
      valueFrom:
        secretKeyRef:
          name: passport-secret
          key: PASSPORT_SECRET
    SPRING_DATASOURCE_URL: "jdbc:postgresql://goorm-popcorn-prod-postgres.cds4g0gykt3t.ap-northeast-2.rds.amazonaws.com:5432/popcorn_prod?currentSchema=checkins"
    SPRING_DATASOURCE_USERNAME:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: QR_DB_USERNAME
    SPRING_DATASOURCE_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: QR_DB_PASSWORD
    SPRING_FLYWAY_USER:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: QR_FLYWAY_USERNAME
    SPRING_FLYWAY_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: database-users
          key: QR_FLYWAY_PASSWORD
    SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
    SPRING_FLYWAY_DEFAULT_SCHEMA: "checkins"
    SPRING_FLYWAY_SCHEMAS: "checkins"
    SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA: "checkins"
    SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "2"
    SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "0"
    SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: "5000"
    SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT: "300000"
    SPRING_DATASOURCE_HIKARI_MAX_LIFETIME: "900000"
orderQuery:
  image:
    tag: dev-3e979749
checkIns:
  image:
    tag: dev-3e979749
