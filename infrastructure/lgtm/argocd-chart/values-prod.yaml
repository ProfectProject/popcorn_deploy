loki-stack:
  deploymentMode: SingleBinary

  loki:
    commonConfig:
      replication_factor: 1

    limits_config:
      retention_period: 168h
      max_query_lookback: 168h
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20

  singleBinary:
    replicas: 1

    resources:
      requests:
        cpu: 100m
        memory: 192Mi
      limits:
        cpu: 300m
        memory: 512Mi

    persistence:
      enabled: true
      storageClass: gp3
      size: 20Gi

  # 메모리 사용량이 큰 기본 캐시 비활성화
  read:
    replicas: 0

  write:
    replicas: 0

  backend:
    replicas: 0

  gateway:
    enabled: false

  chunksCache:
    enabled: false

  resultsCache:
    enabled: false

tempo:
  persistence:
    enabled: true
    storageClassName: gp3
    size: 20Gi

  tempo:
    retention: 168h

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi

mimir:
  distributor:
    resources:
      requests:
        cpu: 100m
        memory: 192Mi
      limits:
        cpu: 300m
        memory: 512Mi

  ingester:
    resources:
      requests:
        cpu: 200m
        memory: 384Mi
      limits:
        cpu: 600m
        memory: 1Gi
    persistentVolume:
      size: 20Gi

  querier:
    resources:
      requests:
        cpu: 80m
        memory: 192Mi
      limits:
        cpu: 250m
        memory: 512Mi

  query_frontend:
    resources:
      requests:
        cpu: 80m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 384Mi

  query_scheduler:
    resources:
      requests:
        cpu: 80m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 384Mi

  store_gateway:
    resources:
      requests:
        cpu: 120m
        memory: 256Mi
      limits:
        cpu: 400m
        memory: 640Mi
    persistentVolume:
      size: 20Gi

  compactor:
    resources:
      requests:
        cpu: 120m
        memory: 256Mi
      limits:
        cpu: 400m
        memory: 640Mi
    persistentVolume:
      size: 20Gi

  minio:
    resources:
      requests:
        cpu: 80m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 384Mi
    persistentVolume:
      size: 20Gi

grafana:
  ingress:
    enabled: true
    annotations:
      alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:ap-northeast-2:375896310755:certificate/085e3315-785c-480d-93c2-57f656b60f7b"
      alb.ingress.kubernetes.io/ssl-redirect: "443"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 300m
      memory: 512Mi

  adminPassword: "CHANGE_ME"

  plugins:
    - grafana-piechart-panel
    - grafana-clock-panel
    - grafana-simple-json-datasource

  # 운영 관찰성 대시보드 (SLO 초안)
  dashboards:
    default:
      popcorn-slo-overview:
        json: |
          {
            "id": null,
            "uid": "popcorn-slo-overview",
            "title": "Popcorn SLO Overview",
            "tags": ["popcorn", "slo", "otel"],
            "timezone": "browser",
            "schemaVersion": 39,
            "version": 1,
            "refresh": "30s",
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "panels": [
              {
                "id": 1,
                "type": "timeseries",
                "title": "RPS By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 2,
                "type": "timeseries",
                "title": "5xx Error Rate % By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\",http_response_status_code=~\"5..\"}[5m])) / clamp_min(sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m])), 0.001)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 3,
                "type": "timeseries",
                "title": "P95 Latency (s) By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "histogram_quantile(0.95, sum by (job, le) (rate(http_server_request_duration_seconds_bucket{job=~\"popcorn/.*\"}[5m])))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "s",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 4,
                "type": "timeseries",
                "title": "Started Spans/s By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(otel_sdk_span_started_total{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 5,
                "type": "stat",
                "title": "Overall 5xx Error Rate (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 6, "w": 8, "x": 0, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum(rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\",http_response_status_code=~\"5..\"}[5m])) / clamp_min(sum(rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m])), 0.001)"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "yellow", "value": 1 },
                        { "color": "red", "value": 5 }
                      ]
                    }
                  },
                  "overrides": []
                },
                "options": {
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "orientation": "auto",
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "auto"
                }
              },
              {
                "id": 6,
                "type": "timeseries",
                "title": "JVM Heap Usage % By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 6, "w": 16, "x": 8, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (jvm_memory_used_bytes{job=~\"popcorn/.*\",jvm_memory_type=\"heap\"}) / clamp_min(sum by (job) (jvm_memory_limit_bytes{job=~\"popcorn/.*\",jvm_memory_type=\"heap\"}), 1)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0,
                    "max": 100
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              }
            ]
          }

  # Grafana Unified Alerting 초안 (기본은 Pause 상태)
  alerting:
    rules.yaml:
      apiVersion: 1
      groups:
        - orgId: 1
          name: popcorn-slo-draft
          folder: popcorn-slo
          interval: 1m
          rules:
            - uid: popcorn-slo-5xx-rate
              title: Popcorn SLO 5xx Rate > 5%
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: 100 * sum(rate(http_server_request_duration_seconds_count{job=~"popcorn/.*",http_response_status_code=~"5.."}[5m])) / clamp_min(sum(rate(http_server_request_duration_seconds_count{job=~"popcorn/.*"}[5m])), 0.001)
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 5
                          type: gt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 10m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Popcorn 전체 5xx 에러율이 5% 초과"
                description: "최근 5분 기준 전체 API의 5xx 비율이 임계치(5%)를 초과했습니다."
              labels:
                severity: critical
                team: popcorn-platform
                category: slo
              isPaused: true
            - uid: popcorn-slo-p95-latency
              title: Popcorn SLO P95 Latency > 1.2s
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: histogram_quantile(0.95, sum by (le) (rate(http_server_request_duration_seconds_bucket{job=~"popcorn/.*"}[5m])))
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 1.2
                          type: gt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 10m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Popcorn 전체 P95 지연이 1.2초 초과"
                description: "최근 5분 기준 전체 API P95 지연이 임계치(1.2초)를 초과했습니다."
              labels:
                severity: warning
                team: popcorn-platform
                category: slo
              isPaused: true
            - uid: popcorn-slo-span-drop
              title: Popcorn Span Ingest Too Low
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: sum(rate(otel_sdk_span_started_total{job=~"popcorn/.*"}[5m]))
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 0.05
                          type: lt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 15m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Popcorn Span 유입량 저하"
                description: "최근 5분 기준 span 시작량(rate)이 임계치보다 낮습니다."
              labels:
                severity: warning
                team: popcorn-platform
                category: observability
              isPaused: true

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70

fluent-bit:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 400m
      memory: 512Mi
