loki-stack:
  deploymentMode: SingleBinary

  loki:
    commonConfig:
      replication_factor: 1

    limits_config:
      retention_period: 168h
      max_query_lookback: 168h
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20

  singleBinary:
    replicas: 1

    resources:
      requests:
        cpu: 100m
        memory: 192Mi
      limits:
        cpu: 300m
        memory: 512Mi

    persistence:
      enabled: true
      storageClass: gp3
      size: 20Gi

  # 메모리 사용량이 큰 기본 캐시 비활성화
  read:
    replicas: 0

  write:
    replicas: 0

  backend:
    replicas: 0

  gateway:
    enabled: false

  chunksCache:
    enabled: false

  resultsCache:
    enabled: false

tempo:
  persistence:
    enabled: true
    storageClassName: gp3
    size: 20Gi

  tempo:
    retention: 168h

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi

mimir:
  distributor:
    resources:
      requests:
        cpu: 100m
        memory: 192Mi
      limits:
        cpu: 300m
        memory: 512Mi

  ingester:
    resources:
      requests:
        cpu: 200m
        memory: 384Mi
      limits:
        cpu: 600m
        memory: 1Gi
    persistentVolume:
      size: 20Gi

  querier:
    resources:
      requests:
        cpu: 80m
        memory: 192Mi
      limits:
        cpu: 250m
        memory: 512Mi

  query_frontend:
    resources:
      requests:
        cpu: 80m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 384Mi

  query_scheduler:
    resources:
      requests:
        cpu: 80m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 384Mi

  store_gateway:
    resources:
      requests:
        cpu: 120m
        memory: 256Mi
      limits:
        cpu: 400m
        memory: 640Mi
    persistentVolume:
      size: 20Gi

  compactor:
    resources:
      requests:
        cpu: 120m
        memory: 256Mi
      limits:
        cpu: 400m
        memory: 640Mi
    persistentVolume:
      size: 20Gi

  minio:
    resources:
      requests:
        cpu: 80m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 384Mi
    persistentVolume:
      size: 20Gi

grafana:
  ingress:
    enabled: true
    annotations:
      alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:ap-northeast-2:375896310755:certificate/085e3315-785c-480d-93c2-57f656b60f7b"
      alb.ingress.kubernetes.io/ssl-redirect: "443"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 300m
      memory: 512Mi

  # PVC 내 stale 경로 정리(추가 대시보드 subPath 마운트 충돌 방지)
  extraInitContainers:
    - name: cleanup-dashboard-mount-paths
      image: docker.io/library/busybox:1.36.1
      imagePullPolicy: IfNotPresent
      command:
        - /bin/sh
        - -c
      args:
        - |
          set -eu
          mkdir -p /var/lib/grafana/dashboards/default
          rm -rf /var/lib/grafana/dashboards/default/popcorn-logs-overview.json
          rm -rf /var/lib/grafana/dashboards/default/popcorn-metrics-overview.json
          rm -rf /var/lib/grafana/dashboards/default/popcorn-traces-overview.json
      securityContext:
        runAsUser: 472
        runAsGroup: 472
      volumeMounts:
        - name: storage
          mountPath: /var/lib/grafana

  adminPassword: "CHANGE_ME"

  envValueFrom:
    DISCORD_WEBHOOK_URL:
      secretKeyRef:
        name: grafana-alerting-webhooks
        key: discord-webhook-url

  plugins:
    - grafana-piechart-panel
    - grafana-clock-panel
    - grafana-simple-json-datasource

  # 운영 관찰성 대시보드 (SLO + Signal별 운영보드)
  dashboards:
    default:
      popcorn-slo-overview:
        json: |
          {
            "id": null,
            "uid": "popcorn-slo-overview",
            "title": "Popcorn SLO Overview",
            "tags": ["popcorn", "slo", "otel"],
            "timezone": "browser",
            "schemaVersion": 39,
            "version": 1,
            "refresh": "30s",
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "panels": [
              {
                "id": 1,
                "type": "timeseries",
                "title": "RPS By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 2,
                "type": "timeseries",
                "title": "5xx Error Rate % By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\",http_response_status_code=~\"5..\"}[5m])) / clamp_min(sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m])), 0.001)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 3,
                "type": "timeseries",
                "title": "P95 Latency (s) By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "histogram_quantile(0.95, sum by (job, le) (rate(http_server_request_duration_seconds_bucket{job=~\"popcorn/.*\"}[5m])))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "s",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 4,
                "type": "timeseries",
                "title": "Started Spans/s By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(otel_sdk_span_started_total{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 5,
                "type": "stat",
                "title": "Overall 5xx Error Rate (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 6, "w": 8, "x": 0, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum(rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\",http_response_status_code=~\"5..\"}[5m])) / clamp_min(sum(rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m])), 0.001)"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "yellow", "value": 1 },
                        { "color": "red", "value": 5 }
                      ]
                    }
                  },
                  "overrides": []
                },
                "options": {
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "orientation": "auto",
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "auto"
                }
              },
              {
                "id": 6,
                "type": "timeseries",
                "title": "JVM Heap Usage % By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 6, "w": 16, "x": 8, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (jvm_memory_used_bytes{job=~\"popcorn/.*\",jvm_memory_type=\"heap\"}) / clamp_min(sum by (job) (jvm_memory_limit_bytes{job=~\"popcorn/.*\",jvm_memory_type=\"heap\"}), 1)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0,
                    "max": 100
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              }
            ]
          }
      popcorn-logs-overview:
        json: |
          {
            "id": null,
            "uid": "popcorn-logs-overview",
            "title": "Popcorn Logs Operations",
            "tags": ["popcorn", "logs", "loki"],
            "timezone": "browser",
            "schemaVersion": 39,
            "version": 1,
            "refresh": "30s",
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "templating": {
              "list": [
                {
                  "name": "namespace",
                  "label": "namespace",
                  "type": "query",
                  "datasource": {
                    "type": "loki",
                    "uid": "loki"
                  },
                  "query": "label_values(namespace)",
                  "refresh": 2,
                  "multi": true,
                  "includeAll": true,
                  "allValue": ".*",
                  "current": {
                    "selected": false,
                    "text": "popcorn-prod",
                    "value": "popcorn-prod"
                  }
                },
                {
                  "name": "service_name",
                  "label": "service",
                  "type": "query",
                  "datasource": {
                    "type": "loki",
                    "uid": "loki"
                  },
                  "query": "label_values({namespace=~\"$namespace\"}, service_name)",
                  "refresh": 2,
                  "multi": true,
                  "includeAll": true,
                  "allValue": ".*",
                  "current": {
                    "selected": true,
                    "text": "All",
                    "value": "$__all"
                  }
                },
                {
                  "name": "pod",
                  "label": "pod",
                  "type": "query",
                  "datasource": {
                    "type": "loki",
                    "uid": "loki"
                  },
                  "query": "label_values({namespace=~\"$namespace\",service_name=~\"$service_name\"}, pod)",
                  "refresh": 2,
                  "multi": true,
                  "includeAll": true,
                  "allValue": ".*",
                  "current": {
                    "selected": true,
                    "text": "All",
                    "value": "$__all"
                  }
                },
                {
                  "name": "container",
                  "label": "container",
                  "type": "query",
                  "datasource": {
                    "type": "loki",
                    "uid": "loki"
                  },
                  "query": "label_values({namespace=~\"$namespace\",pod=~\"$pod\"}, container)",
                  "refresh": 2,
                  "multi": true,
                  "includeAll": true,
                  "allValue": ".*",
                  "current": {
                    "selected": true,
                    "text": "All",
                    "value": "$__all"
                  }
                },
                {
                  "name": "level",
                  "label": "level",
                  "type": "custom",
                  "query": "ERROR,WARN,INFO,DEBUG,TRACE",
                  "multi": false,
                  "includeAll": true,
                  "allValue": ".*",
                  "current": {
                    "selected": true,
                    "text": "All",
                    "value": "$__all"
                  }
                },
                {
                  "name": "search",
                  "label": "search",
                  "type": "textbox",
                  "query": "",
                  "current": {
                    "selected": false,
                    "text": "",
                    "value": ""
                  }
                },
                {
                  "name": "trace_id",
                  "label": "traceId(regex)",
                  "type": "textbox",
                  "query": ".*",
                  "current": {
                    "selected": false,
                    "text": ".*",
                    "value": ".*"
                  }
                }
              ]
            },
            "panels": [
              {
                "id": 1,
                "type": "timeseries",
                "title": "ERROR Logs per 5m By Service",
                "datasource": {
                  "type": "loki",
                  "uid": "loki"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (service_name) (count_over_time({namespace=~\"$namespace\",service_name=~\"$service_name\",pod=~\"$pod\",container=~\"$container\"} | json | level=\"ERROR\" |= \"$search\" [5m]))",
                    "legendFormat": "{{service_name}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 2,
                "type": "timeseries",
                "title": "WARN Logs per 5m By Service",
                "datasource": {
                  "type": "loki",
                  "uid": "loki"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (service_name) (count_over_time({namespace=~\"$namespace\",service_name=~\"$service_name\",pod=~\"$pod\",container=~\"$container\"} | json | level=\"WARN\" |= \"$search\" [5m]))",
                    "legendFormat": "{{service_name}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 3,
                "type": "timeseries",
                "title": "Sensitive Keyword Hits per 5m By Pod",
                "datasource": {
                  "type": "loki",
                  "uid": "loki"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (pod) (count_over_time({namespace=~\"$namespace\",service_name=~\"$service_name\",pod=~\"$pod\",container=~\"$container\"} |~ \"(?i)(passport.secret|authorization|password|token)\" [5m]))",
                    "legendFormat": "{{pod}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 4,
                "type": "timeseries",
                "title": "4xx/5xx Completion Logs per 5m By Service",
                "datasource": {
                  "type": "loki",
                  "uid": "loki"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (service_name) (count_over_time({namespace=~\"$namespace\",service_name=~\"$service_name\",pod=~\"$pod\",container=~\"$container\"} | json | message=~\".*Completed (4|5)[0-9][0-9].*\" |= \"$search\" [5m]))",
                    "legendFormat": "{{service_name}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 5,
                "type": "logs",
                "title": "Recent Logs (Variable Filtered)",
                "datasource": {
                  "type": "loki",
                  "uid": "loki"
                },
                "gridPos": { "h": 10, "w": 12, "x": 0, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "{namespace=~\"$namespace\",service_name=~\"$service_name\",pod=~\"$pod\",container=~\"$container\"} |= \"$search\""
                  }
                ],
                "options": {
                  "dedupStrategy": "none",
                  "enableLogDetails": true,
                  "prettifyLogMessage": false,
                  "showCommonLabels": false,
                  "showLabels": true,
                  "showTime": true,
                  "sortOrder": "Descending",
                  "wrapLogMessage": true
                }
              },
              {
                "id": 6,
                "type": "logs",
                "title": "Trace Correlation Logs",
                "datasource": {
                  "type": "loki",
                  "uid": "loki"
                },
                "gridPos": { "h": 10, "w": 12, "x": 12, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "{namespace=~\"$namespace\",service_name=~\"$service_name\",pod=~\"$pod\",container=~\"$container\"} | json | level=~\"$level\" | traceId=~\"$trace_id\" |= \"$search\""
                  }
                ],
                "options": {
                  "dedupStrategy": "none",
                  "enableLogDetails": true,
                  "prettifyLogMessage": false,
                  "showCommonLabels": false,
                  "showLabels": true,
                  "showTime": true,
                  "sortOrder": "Descending",
                  "wrapLogMessage": true
                }
              }
            ]
          }
      popcorn-metrics-overview:
        json: |
          {
            "id": null,
            "uid": "popcorn-metrics-overview",
            "title": "Popcorn Metrics Operations",
            "tags": ["popcorn", "metrics", "mimir"],
            "timezone": "browser",
            "schemaVersion": 39,
            "version": 1,
            "refresh": "30s",
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "panels": [
              {
                "id": 1,
                "type": "timeseries",
                "title": "RPS By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 2,
                "type": "timeseries",
                "title": "5xx Error Rate % By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\",http_response_status_code=~\"5..\"}[5m])) / clamp_min(sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m])), 0.001)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 3,
                "type": "timeseries",
                "title": "Server P95 Latency (s) By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "histogram_quantile(0.95, sum by (job, le) (rate(http_server_request_duration_seconds_bucket{job=~\"popcorn/.*\"}[5m])))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "s",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 4,
                "type": "timeseries",
                "title": "Outbound HTTP P95 Latency (s) By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "histogram_quantile(0.95, sum by (job, le) (rate(http_client_request_duration_seconds_bucket{job=~\"popcorn/.*\"}[5m])))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "s",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 5,
                "type": "timeseries",
                "title": "JVM Heap Usage % By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (jvm_memory_used_bytes{job=~\"popcorn/.*\",jvm_memory_type=\"heap\"}) / clamp_min(sum by (job) (jvm_memory_limit_bytes{job=~\"popcorn/.*\",jvm_memory_type=\"heap\"}), 1)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0,
                    "max": 100
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 6,
                "type": "timeseries",
                "title": "DB Connection Used Ratio % By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (db_client_connections_usage{job=~\"popcorn/.*\",state=\"used\"}) / clamp_min(sum by (job) (db_client_connections_usage{job=~\"popcorn/.*\"}), 1)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0,
                    "max": 100
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 7,
                "type": "timeseries",
                "title": "Kafka Consumer Lag Max By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (kafka_consumer_records_lag_max{job=~\"popcorn/.*\"})",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 8,
                "type": "timeseries",
                "title": "Outbound HTTP RPS By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(http_client_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              }
            ]
          }
      popcorn-traces-overview:
        json: |
          {
            "id": null,
            "uid": "popcorn-traces-overview",
            "title": "Popcorn Traces Operations",
            "tags": ["popcorn", "traces", "tempo", "otel"],
            "timezone": "browser",
            "schemaVersion": 39,
            "version": 1,
            "refresh": "30s",
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "panels": [
              {
                "id": 1,
                "type": "timeseries",
                "title": "Started Spans/s By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(otel_sdk_span_started_total{job=~\"popcorn/.*\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 2,
                "type": "timeseries",
                "title": "Span-to-Request Ratio By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(otel_sdk_span_started_total{job=~\"popcorn/.*\"}[5m])) / clamp_min(sum by (job) (rate(http_server_request_duration_seconds_count{job=~\"popcorn/.*\"}[5m])), 0.001)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "short",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 3,
                "type": "timeseries",
                "title": "OTLP Span Export Success % (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "100 * sum by (job) (rate(otlp_exporter_exported_total{job=~\"popcorn/.*\",type=\"span\",success=\"true\"}[5m])) / clamp_min(sum by (job) (rate(otlp_exporter_seen_total{job=~\"popcorn/.*\",type=\"span\"}[5m])), 0.001)",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "percent",
                    "min": 0,
                    "max": 100
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 4,
                "type": "timeseries",
                "title": "Exported Spans/s By Service (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (rate(otlp_exporter_exported_total{job=~\"popcorn/.*\",type=\"span\",success=\"true\"}[5m]))",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "reqps",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 5,
                "type": "timeseries",
                "title": "Live Spans By Service",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "sum by (job) (otel_sdk_span_live{job=~\"popcorn/.*\"})",
                    "legendFormat": "{{job}}"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "unit": "short",
                    "min": 0
                  },
                  "overrides": []
                },
                "options": {
                  "legend": { "displayMode": "table", "placement": "bottom" },
                  "tooltip": { "mode": "multi", "sort": "desc" }
                }
              },
              {
                "id": 6,
                "type": "stat",
                "title": "Trace Reporting Services (5m)",
                "datasource": {
                  "type": "prometheus",
                  "uid": "mimir"
                },
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
                "targets": [
                  {
                    "refId": "A",
                    "expr": "count(sum by (job) (rate(otel_sdk_span_started_total{job=~\"popcorn/.*\"}[5m])) > 0)"
                  }
                ],
                "fieldConfig": {
                  "defaults": {
                    "min": 0,
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "red", "value": null },
                        { "color": "yellow", "value": 6 },
                        { "color": "green", "value": 8 }
                      ]
                    }
                  },
                  "overrides": []
                },
                "options": {
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "orientation": "auto",
                  "colorMode": "value",
                  "graphMode": "none",
                  "justifyMode": "auto"
                }
              }
            ]
          }

  # Grafana Unified Alerting (운영 활성화)
  alerting:
    contactpoints.yaml:
      apiVersion: 1
      deleteContactPoints:
        - orgId: 1
          uid: popcorn-slo-email
      contactPoints:
        - orgId: 1
          name: popcorn-slo
          receivers:
            - uid: popcorn-slo-discord
              type: discord
              settings:
                url: $DISCORD_WEBHOOK_URL
                use_discord_username: false
                message: |
                  {{ `{{ template "default.message" . }}` }}
              disableResolveMessage: false

    policies.yaml:
      apiVersion: 1
      policies:
        - orgId: 1
          receiver: popcorn-slo
          group_by:
            - alertname
            - job
            - severity
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
          routes:
            - receiver: popcorn-slo
              object_matchers:
                - - team
                  - =
                  - popcorn-platform

    rules.yaml:
      apiVersion: 1
      deleteRules:
        - orgId: 1
          uid: popcorn-slo-5xx-rate
        - orgId: 1
          uid: popcorn-slo-p95-latency
        - orgId: 1
          uid: popcorn-slo-span-drop
      groups:
        - orgId: 1
          name: popcorn-slo
          folder: popcorn-slo
          interval: 1m
          rules:
            - uid: popcorn-gateway-5xx-critical
              title: Gateway 5xx Rate > 2%
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: 100 * sum(rate(http_server_request_duration_seconds_count{job="popcorn/gateway",http_response_status_code=~"5.."}[5m])) / clamp_min(sum(rate(http_server_request_duration_seconds_count{job="popcorn/gateway"}[5m])), 0.001)
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 2
                          type: gt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 10m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Gateway 5xx 비율 임계치 초과"
                description: "최근 5분 기준 gateway 5xx 비율이 2%를 초과했습니다."
              labels:
                severity: critical
                team: popcorn-platform
                category: slo
                job: popcorn/gateway
              isPaused: false
            - uid: popcorn-core-5xx-critical
              title: Core Services 5xx Rate > 5%
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: 100 * sum by (job) (rate(http_server_request_duration_seconds_count{job=~"popcorn/(users|stores|order|order-query|payment|checkins|coupon)",http_response_status_code=~"5.."}[5m])) / clamp_min(sum by (job) (rate(http_server_request_duration_seconds_count{job=~"popcorn/(users|stores|order|order-query|payment|checkins|coupon)"}[5m])), 0.001)
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 5
                          type: gt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 10m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Core 서비스 5xx 비율 임계치 초과"
                description: "최근 5분 기준 core 서비스의 5xx 비율이 5%를 초과했습니다."
              labels:
                severity: critical
                team: popcorn-platform
                category: slo
              isPaused: false
            - uid: popcorn-gateway-p95-warning
              title: Gateway P95 Latency > 0.8s
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: histogram_quantile(0.95, sum by (le) (rate(http_server_request_duration_seconds_bucket{job="popcorn/gateway"}[5m])))
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 0.8
                          type: gt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 10m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Gateway P95 지연 임계치 초과"
                description: "최근 5분 기준 gateway P95 지연이 0.8초를 초과했습니다."
              labels:
                severity: warning
                team: popcorn-platform
                category: slo
                job: popcorn/gateway
              isPaused: false
            - uid: popcorn-core-p95-warning
              title: Core Services P95 Latency > 1.5s
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: histogram_quantile(0.95, sum by (job, le) (rate(http_server_request_duration_seconds_bucket{job=~"popcorn/(users|stores|order|order-query|payment|checkins|coupon)"}[5m])))
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 1.5
                          type: gt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 10m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Core 서비스 P95 지연 임계치 초과"
                description: "최근 5분 기준 core 서비스 P95 지연이 1.5초를 초과했습니다."
              labels:
                severity: warning
                team: popcorn-platform
                category: slo
              isPaused: false
            - uid: popcorn-trace-coverage-warning
              title: Trace Coverage Ratio < 0.5
              condition: C
              data:
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: mimir
                  model:
                    datasource:
                      type: prometheus
                      uid: mimir
                    editorMode: code
                    expr: sum by (job) (rate(otel_sdk_span_started_total{job=~"popcorn/.*"}[5m])) / clamp_min(sum by (job) (rate(http_server_request_duration_seconds_count{job=~"popcorn/.*"}[5m])), 0.001)
                    instant: true
                    intervalMs: 1000
                    maxDataPoints: 43200
                    range: false
                    refId: A
                - refId: C
                  relativeTimeRange:
                    from: 0
                    to: 0
                  datasourceUid: "-100"
                  model:
                    conditions:
                      - evaluator:
                          params:
                            - 0.5
                          type: lt
                        operator:
                          type: and
                        query:
                          params:
                            - A
                        reducer:
                          params: []
                          type: last
                        type: query
                    datasource:
                      type: __expr__
                      uid: "-100"
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
              for: 15m
              noDataState: NoData
              execErrState: Error
              annotations:
                summary: "Trace 커버리지 저하"
                description: "최근 5분 기준 span/request 비율이 0.5 미만으로 떨어졌습니다."
              labels:
                severity: warning
                team: popcorn-platform
                category: observability
              isPaused: false

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70

fluent-bit:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 400m
      memory: 512Mi
